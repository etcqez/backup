#+title: 配置新系统

* 制作带inst.ks的iso
** 复制isolinux
1. sudo mkdir /data/myiso
2. sudo chown -R f:f /data
3. s -i
4. mount /var/lib/libvirt/images/openEuler-22.09-x86_64-dvd.iso /mnt
5. \cp -r /mnt/isolinux /data/myiso
** 修改isolinux.cfg
#+begin_src cfg
# 自动安装
label linux
  menu label ^Auto Install openEuler 22.09
  kernel vmlinuz
  append initrd=initrd.img quiet ks=192.168.3.11/ks/openEuler-ks.cfg
# 救援模式
label rescue
  menu label ^Rescue a openEuler system
  kernel vmlinuz
  append initrd=initrd.img inst.stage2=hd:LABEL=openEuler-22.09-x86_64 rescue quiet
# 本地磁盘
label local
  menu default
  menu label Boot from ^local drive
  localboot 0xffff
#+end_src
** 挂载安装光盘
1. mkdir /var/www/localhost/htdocs/mnt
2. s mount /var/lib/libvirt/images/openEuler-22.09-x86_64-dvd.iso /var/www/localhost/htdocs/mnt
** 修改openEuler-ks.cfg
#+begin_src cfg
# Generated by pykickstart v3.34
#version=DEVEL
# Use graphical install
text


%packages
@^minimal-environment
vim
%end

# Keyboard layouts
keyboard --xlayouts='cn'
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=enp1s0 --ipv6=auto --no-activate
network  --hostname=localhost.localdomain

# Use hard drive installation media
#harddrive --dir= --partition=LABEL=openEuler-22.09-x86_64
url --url=http://192.168.3.11/mnt

# Run the Setup Agent on first boot
firstboot --enable
# System services
services --enabled="chronyd"

ignoredisk --only-use=vda
autopart
# Partition clearing information
clearpart --none --initlabel

# System timezone
timezone Asia/Shanghai --utc

# Root password
rootpw --iscrypted $6$sgafbNbdJ/KSf/hV$pc.1dAyC5LGxyIvnPqGJM7zC9MrhpkV5N2Xb86OPMTm00EPuvEfnZJ.gzXu0RxRbZZ57UVLoEgAEsbA5epXo.1

%addon com_redhat_kdump --disable --reserve-mb='128'

%end

%anaconda
pwpolicy root --minlen=8 --minquality=1 --strict --nochanges --notempty
pwpolicy user --minlen=8 --minquality=1 --strict --nochanges --emptyok
pwpolicy luks --minlen=8 --minquality=1 --strict --nochanges --notempty
%end

%post
mkdir /root/.ssh -m 700
cat > /root/.ssh/authorized_keys <<EOF
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCw9af1tZMbCPqoHZLeRCGGshTqcVGTU2yvPQo0+ziM8MLYhJvdZU+vBueXPDIdmIcjPIoALWgY3IxOsI386PoCxYRN05KoYiKOcSNE58HrkmZNvqHfXvIdkpL3stX5dTdEoNnAswbLeYV5NTqUu1kIveGkjMnTK9MO2dJwwuhf9VhXiJ3BdRHb8IWX2lDIzi4JbG6q3ITPiEIig0K+MwTVroOLX2hPTcOg9ftsPqjHY46ciwUAGRpSeBEsnPhbOIz7/dG9dgyonC8TjWB2QhZfemXY0d68G9ZvsPOnY0vUfUU47R7cRDwUSrQ3WacI/Na1GgaUcPuylNYShscQqSHF+sdXW2/soEJLHRfPwCkp2fA2LDFm3O24D7eoyJQkhwSfzQulN0zNTtMwURvUWN79jMrqWzmXTzVid82/6P1/D9g8LaUuDXDnZRE52Mk4CtEgn8E/6kXuiWolmmwe2CIDMXsqnwa57tPhUu7emX+PsdNK+vosP/S2Vhh7abane7k= f@gentoo
EOF
chmod 600 /root/.ssh/authorized_keys
%end

#+end_src
** 生成iso文件
#+begin_src shell
mkisofs -R -J -T -v -no-emul-boot -boot-lead-size 4 -boot-info-table -V "OpenEuler 22.09 x86_64 boot" -b isolinux/isolinux.bin -c isolinux/boot.cat -o /root/boot.iso /data/myiso
#+end_src
* 配置网络
#+begin_src shell
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp1s0
# Generated by parse-kickstart
TYPE=Ethernet
DEVICE=enp1s0
UUID=97809ea8-b9a1-4d1b-985b-03e142b1b740
ONBOOT=yes
BOOTPROTO=none
IPADDR=192.168.122.45
PREFIX=24
GATEWAY=192.168.122.1
DNS1=8.8.8.8
IPV6INIT=yes
IPV6_AUTOCONF=yes
PROXY_METHOD=none
BROWSER_ONLY=no
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
IPV6INIT=yes
NAME="System enp1s0"

[root@localhost ~]# cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 8.8.8.8
#+end_src
- *网络不通*
  #+begin_src shell
GATEWAY=192.168.122.1
DNS1=8.8.8.8
  #+end_src
